<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhabelais GEPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    
    <!-- LOGIN -->
    <div id="pageLogin" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="text-center">
                <div class="mx-auto h-16 w-16 bg-teal-600 rounded-lg flex items-center justify-center mb-4">
                    <span class="text-white font-bold text-xl">RH</span>
                </div>
                <h1 class="text-2xl font-bold">Rhabelais GEPP</h1>
                <p class="text-gray-600 text-sm mt-2">Gestion des Comp√©tences</p>
            </div>
            
            <!-- Formulaire de connexion -->
            <div id="loginFormContainer">
                <form id="loginForm" class="space-y-4">
                    <input id="loginEmail" type="email" required value="contact@rhabelais.fr"
                        placeholder="Email" class="w-full px-3 py-2 border rounded-lg">
                    <input id="loginPassword" type="password" required
                        placeholder="Mot de passe" class="w-full px-3 py-2 border rounded-lg">
                    <div id="loginError" class="hidden p-3 bg-red-50 text-sm text-red-800 rounded"></div>
                    <div id="loginSuccess" class="hidden p-3 bg-green-50 text-sm text-green-800 rounded"></div>
                    <button type="submit" class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700">
                        Se connecter
                    </button>
                    <button type="button" onclick="showPasswordReset()" class="w-full text-sm text-teal-600 hover:underline">
                        Mot de passe oubli√© ?
                    </button>
                </form>
            </div>

            <!-- Formulaire de r√©initialisation -->
            <div id="resetFormContainer" class="hidden">
                <button onclick="showLoginForm()" class="text-sm text-gray-600 hover:underline mb-4">
                    ‚Üê Retour √† la connexion
                </button>
                <form id="resetForm" class="space-y-4">
                    <p class="text-sm text-gray-600">Entrez votre email pour recevoir un lien de r√©initialisation</p>
                    <input id="resetEmail" type="email" required
                        placeholder="Email" class="w-full px-3 py-2 border rounded-lg">
                    <div id="resetError" class="hidden p-3 bg-red-50 text-sm text-red-800 rounded"></div>
                    <div id="resetSuccess" class="hidden p-3 bg-green-50 text-sm text-green-800 rounded"></div>
                    <button type="submit" class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700">
                        Envoyer le lien
                    </button>
                </form>
            </div>

            <!-- Formulaire nouveau mot de passe (apr√®s clic sur lien email) -->
            <div id="newPasswordContainer" class="hidden">
                <h2 class="text-xl font-bold mb-4">Nouveau mot de passe</h2>
                <form id="newPasswordForm" class="space-y-4">
                    <p class="text-sm text-gray-600">Entrez votre nouveau mot de passe</p>
                    <input id="newPassword" type="password" required minlength="6"
                        placeholder="Nouveau mot de passe (min 6 caract√®res)" class="w-full px-3 py-2 border rounded-lg">
                    <input id="newPasswordConfirm" type="password" required minlength="6"
                        placeholder="Confirmer le mot de passe" class="w-full px-3 py-2 border rounded-lg">
                    <div id="newPasswordError" class="hidden p-3 bg-red-50 text-sm text-red-800 rounded"></div>
                    <div id="newPasswordSuccess" class="hidden p-3 bg-green-50 text-sm text-green-800 rounded"></div>
                    <button type="submit" class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700">
                        Changer le mot de passe
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="pageDashboard" class="hidden min-h-screen">
        <header class="bg-gradient-to-r from-teal-700 to-teal-500 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="showHome()" class="text-2xl hover:bg-white/20 px-3 py-1 rounded" title="Accueil">
                            üè†
                        </button>
                        <div>
                            <h1 class="text-xl font-bold">Rhabelais GEPP</h1>
                            <p class="text-sm opacity-90" id="userInfo">Chargement...</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-white/20 rounded hover:bg-white/30">
                        D√©connexion
                    </button>
                </div>
            </div>
        </header>

        <!-- ACCUEIL -->
        <div id="pageHome" class="hidden">
            <div class="max-w-7xl mx-auto px-4 py-8">
                <!-- KPIs Accueil -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="homeCollabs">0</div>
                        <div class="text-sm text-gray-600">Collaborateurs</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="homePostes">0</div>
                        <div class="text-sm text-gray-600">Postes</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="homeComps">0</div>
                        <div class="text-sm text-gray-600">Comp√©tences</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-red-600" id="homeEcarts">0</div>
                        <div class="text-sm text-gray-600">√âcarts</div>
                    </div>
                </div>

                <!-- Actions rapides ADMIN -->
                <div id="adminActions" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="showStep(0)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">üë•</div>
                        <div class="font-bold text-sm">Gestion Utilisateurs</div>
                    </button>
                    <button onclick="showStep(1)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">üìã</div>
                        <div class="font-bold text-sm">Cr√©er Postes</div>
                    </button>
                    <button onclick="showStep(2)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">üéØ</div>
                        <div class="font-bold text-sm">Comp√©tences</div>
                    </button>
                    <button onclick="showStep(3)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">‚ûï</div>
                        <div class="font-bold text-sm">Ajouter Salari√©</div>
                    </button>
                    <button onclick="showStep(4)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">üìù</div>
                        <div class="font-bold text-sm">√âvaluer</div>
                    </button>
                    <button onclick="showStep(5)" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="text-4xl mb-2">üìä</div>
                        <div class="font-bold text-sm">R√©sultats</div>
                    </button>
                    <button onclick="exporterBase()" class="bg-green-50 p-6 rounded-lg shadow hover:shadow-lg transition border-2 border-green-200">
                        <div class="text-4xl mb-2">üì§</div>
                        <div class="font-bold text-sm text-green-700">Export Base</div>
                    </button>
                    <button onclick="showImport()" class="bg-orange-50 p-6 rounded-lg shadow hover:shadow-lg transition border-2 border-orange-200">
                        <div class="text-4xl mb-2">üì•</div>
                        <div class="font-bold text-sm text-orange-700">Import/Restaurer</div>
                    </button>
                </div>

                <!-- Vue Manager -->
                <div id="managerView" class="hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üë• Mon √âquipe</h2>
                        <div id="managerTeam">Chargement...</div>
                    </div>
                    <button onclick="showEvalManager()" class="px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        üìù √âvaluer mes collaborateurs
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation par √©tapes (ADMIN uniquement) -->
        <div id="navSteps" class="hidden bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex overflow-x-auto">
                    <button onclick="showStep(0)" id="tab0" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        0Ô∏è‚É£ Utilisateurs
                    </button>
                    <button onclick="showStep(1)" id="tab1" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        1Ô∏è‚É£ Postes
                    </button>
                    <button onclick="showStep(2)" id="tab2" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        2Ô∏è‚É£ Comp√©tences
                    </button>
                    <button onclick="showStep(3)" id="tab3" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        3Ô∏è‚É£ Salari√©s
                    </button>
                    <button onclick="showStep(4)" id="tab4" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        4Ô∏è‚É£ √âvaluer
                    </button>
                    <button onclick="showStep(5)" id="tab5" class="px-6 py-4 border-b-2 border-transparent hover:border-teal-500 whitespace-nowrap">
                        üìä R√©sultats
                    </button>
                </div>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 py-8">
            
            <!-- √âTAPE 0 : GESTION UTILISATEURS -->
            <div id="step0" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üë• Cr√©er un Manager</h2>
                    <p class="text-gray-600 mb-6">Les managers pourront se connecter et √©valuer leurs √©quipes</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="mgrEmail" placeholder="Email du manager" class="px-3 py-2 border rounded-lg">
                        <input id="mgrNom" placeholder="Nom complet" class="px-3 py-2 border rounded-lg">
                        <input id="mgrPassword" type="password" placeholder="Mot de passe" class="px-3 py-2 border rounded-lg col-span-2">
                    </div>
                    <button onclick="creerManager()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        ‚ûï Cr√©er Manager
                    </button>
                    <div id="mgrStatus" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4">Liste des Managers</h3>
                    <div id="listeManagers">Chargement...</div>
                </div>
            </div>

            <!-- √âTAPE 1 : POSTES -->
            <div id="step1" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üìã Cr√©er les Postes</h2>
                    <p class="text-gray-600 mb-6">D√©finissez tous les postes de votre entreprise</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="posteNom" placeholder="Nom du poste" class="px-3 py-2 border rounded-lg">
                        <input id="posteDesc" placeholder="Description" class="px-3 py-2 border rounded-lg">
                    </div>
                    <button onclick="ajouterPoste()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        ‚ûï Ajouter Poste
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4">Liste des Postes</h3>
                    <div id="listePostes">Chargement...</div>
                </div>
            </div>

            <!-- √âTAPE 2 : COMP√âTENCES PAR POSTE -->
            <div id="step2" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üéØ Comp√©tences par Poste</h2>
                    <p class="text-gray-600 mb-6">D√©finissez les comp√©tences requises pour chaque poste</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select id="compPosteSelect" class="px-3 py-2 border rounded-lg">
                            <option value="">S√©lectionner un poste</option>
                        </select>
                        <input id="compNom" placeholder="Nom comp√©tence" class="px-3 py-2 border rounded-lg">
                        <select id="compCategorie" class="px-3 py-2 border rounded-lg">
                            <option>Technique</option>
                            <option>S√©curit√©</option>
                            <option>Qualit√©</option>
                            <option>Management</option>
                            <option>Relationnelle</option>
                        </select>
                        <input id="compNiveauReqis" type="number" min="0" max="5" placeholder="Niveau requis (0-5)" class="px-3 py-2 border rounded-lg">
                    </div>
                    <button onclick="ajouterCompetencePoste()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        ‚ûï Ajouter Comp√©tence
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4">Comp√©tences par Poste</h3>
                    <div id="listeCompetencesPostes">Chargement...</div>
                </div>
            </div>

            <!-- √âTAPE 3 : SALARI√âS -->
            <div id="step3" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üë§ Cr√©er un Salari√©</h2>
                    <p class="text-gray-600 mb-6">Ajoutez un salari√© et assignez-le √† un poste et un manager</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="salNom" placeholder="Nom" class="px-3 py-2 border rounded-lg">
                        <input id="salPrenom" placeholder="Pr√©nom" class="px-3 py-2 border rounded-lg">
                        <input id="salEmail" placeholder="Email" class="px-3 py-2 border rounded-lg col-span-2">
                        <select id="salPoste" class="px-3 py-2 border rounded-lg">
                            <option value="">S√©lectionner un poste</option>
                        </select>
                        <select id="salManager" class="px-3 py-2 border rounded-lg">
                            <option value="">S√©lectionner un manager</option>
                        </select>
                    </div>
                    <button onclick="ajouterSalarie()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        ‚ûï Ajouter Salari√©
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4">Liste des Salari√©s</h3>
                    <div id="listeSalaries">Chargement...</div>
                </div>
            </div>

            <!-- √âTAPE 4 : √âVALUER (ADMIN) -->
            <div id="step4" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üìù √âvaluer les Salari√©s</h2>
                    <p class="text-gray-600 mb-6">√âvaluez le niveau actuel de chaque salari√©</p>
                    
                    <div class="mb-4">
                        <select id="evalSalarie" onchange="chargerCompetencesSalarie()" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">S√©lectionner un salari√©</option>
                        </select>
                    </div>

                    <div id="evalCompetences" class="space-y-3"></div>
                    
                    <button onclick="enregistrerEvaluations()" id="btnSaveEval" class="hidden mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üíæ Enregistrer √âvaluations
                    </button>
                </div>
            </div>

            <!-- √âVALUER (MANAGER) -->
            <div id="stepEvalManager" class="hidden">
                <!-- Onglet √©valuation -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">üìù √âvaluer Mon √âquipe</h2>
                    <p class="text-gray-600 mb-6">Modifiez les niveaux de comp√©tences de vos collaborateurs</p>
                    
                    <div class="mb-4">
                        <select id="evalManagerSalarie" onchange="chargerCompetencesSalarieManager()" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">S√©lectionner un collaborateur</option>
                        </select>
                    </div>

                    <div id="evalManagerCompetences" class="space-y-3"></div>
                    
                    <button onclick="enregistrerEvaluationsManager()" id="btnSaveEvalManager" class="hidden mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üíæ Enregistrer
                    </button>
                </div>

                <!-- Onglet √©carts de l'√©quipe -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">üìä √âcarts de Comp√©tences - Mon √âquipe</h2>
                    <p class="text-gray-600 mb-6">Visualisez les besoins en formation de votre √©quipe</p>
                    
                    <!-- KPIs -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-blue-600" id="managerCollabs">0</div>
                            <div class="text-sm text-gray-600">Collaborateurs</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-orange-600" id="managerEcarts">0</div>
                            <div class="text-sm text-gray-600">√âcarts</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-purple-600" id="managerComps">0</div>
                            <div class="text-sm text-gray-600">Comp√©tences √† former</div>
                        </div>
                    </div>

                    <!-- Bouton rafra√Æchir -->
                    <button onclick="chargerEcartsManager()" class="mb-4 px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">
                        üîÑ Actualiser
                    </button>

                    <!-- Tableau des √©carts -->
                    <div id="tableEcartsManager"></div>
                </div>
            </div>

            <!-- √âTAPE 5 : R√âSULTATS -->
            <div id="step5" class="hidden">
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="resCollabs">0</div>
                        <div class="text-sm text-gray-600">Salari√©s</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="resPostes">0</div>
                        <div class="text-sm text-gray-600">Postes</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold" id="resComps">0</div>
                        <div class="text-sm text-gray-600">Comp√©tences</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-red-600" id="resEcarts">0</div>
                        <div class="text-sm text-gray-600">√âcarts</div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4">üìä √âcarts de Comp√©tences</h3>
                    <div id="tableEcarts">Chargement...</div>
                </div>
            </div>

        </main>
    </div>

    <script>
    const sb = window.supabase.createClient(
        'https://dqmzvxourispelgvjwze.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxbXp2eG91cmlzcGVsZ3Zqd3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzI5MTUsImV4cCI6MjA4NjgwODkxNX0.scxYsQxPypHIx1RlwZhN5jHQs0GTFjliZhU6IWP-qtw'
    );

    // ‚ö†Ô∏è CONFIGURATION EDGE FUNCTION
    // Apr√®s avoir d√©ploy√© l'Edge Function, mettez son URL ici
    const EDGE_FUNCTION_URL = 'https://dqmzvxourispelgvjwze.supabase.co/functions/v1/create-manager';

    let entrepriseId = null;
    let userRole = null;
    let currentUserId = null;

    // D√âTECTER SI ON ARRIVE DEPUIS UN LIEN DE RESET PASSWORD
    window.addEventListener('DOMContentLoaded', async () => {
        // V√©rifier si l'URL contient un hash de reset password
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');

        if (type === 'recovery' && accessToken) {
            // Afficher le formulaire de nouveau mot de passe
            document.getElementById('loginFormContainer').classList.add('hidden');
            document.getElementById('resetFormContainer').classList.add('hidden');
            document.getElementById('newPasswordContainer').classList.remove('hidden');
        }
    });

    // GESTION DU NOUVEAU MOT DE PASSE
    document.getElementById('newPasswordForm').onsubmit = async (e) => {
        e.preventDefault();
        const password = document.getElementById('newPassword').value;
        const confirm = document.getElementById('newPasswordConfirm').value;
        const errorEl = document.getElementById('newPasswordError');
        const successEl = document.getElementById('newPasswordSuccess');

        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');

        if (password !== confirm) {
            errorEl.textContent = 'Les mots de passe ne correspondent pas';
            errorEl.classList.remove('hidden');
            return;
        }

        if (password.length < 6) {
            errorEl.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const { error } = await sb.auth.updateUser({ password: password });

            if (error) throw error;

            successEl.textContent = '‚úÖ Mot de passe chang√© avec succ√®s ! Vous allez √™tre redirig√©...';
            successEl.classList.remove('hidden');

            // Rediriger vers la page de connexion apr√®s 2 secondes
            setTimeout(() => {
                window.location.href = window.location.origin + window.location.pathname;
            }, 2000);

        } catch (error) {
            errorEl.textContent = error.message || 'Erreur lors du changement de mot de passe';
            errorEl.classList.remove('hidden');
        }
    };

    // LOGIN
    document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        const errorEl = document.getElementById('loginError');
        errorEl.classList.add('hidden');
        
        try {
            // √âtape 1 : Authentification
            const { data, error } = await sb.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            
            if (error) {
                console.error('Auth error:', error);
                throw new Error('Email ou mot de passe incorrect');
            }

            if (!data || !data.user) {
                throw new Error('Erreur de connexion : donn√©es utilisateur manquantes');
            }

            currentUserId = data.user.id;
            
            // √âtape 2 : R√©cup√©ration du profil
            const { data: profil, error: profilError } = await sb.from('profils')
                .select('entreprise_id, role, nom_complet, email')
                .eq('id', data.user.id)
                .single();
            
            if (profilError) {
                console.error('Profil error:', profilError);
                throw new Error(`Erreur profil : ${profilError.message}`);
            }
            
            if (!profil) {
                throw new Error('Aucun profil trouv√© pour cet utilisateur. Contactez l\'administrateur.');
            }
            
            if (!profil.entreprise_id) {
                throw new Error('Profil incomplet : entreprise_id manquant. Contactez l\'administrateur.');
            }
            
            // √âtape 3 : Configuration
            entrepriseId = profil.entreprise_id;
            userRole = profil.role;
            
            const roleLabel = userRole === 'admin_rh' ? 'Admin RH' : 'Manager';
            document.getElementById('userInfo').textContent = `${profil.nom_complet || profil.email || data.user.email} (${roleLabel})`;
            
            // √âtape 4 : Affichage
            document.getElementById('pageLogin').classList.add('hidden');
            document.getElementById('pageDashboard').classList.remove('hidden');
            
            showHome();
        } catch (error) {
            console.error('Login error:', error);
            errorEl.textContent = error.message || 'Erreur de connexion';
            errorEl.classList.remove('hidden');
        }
    };

    async function logout() {
        await sb.auth.signOut();
        location.reload();
    }

    // R√âINITIALISATION MOT DE PASSE
    function showPasswordReset() {
        document.getElementById('loginFormContainer').classList.add('hidden');
        document.getElementById('resetFormContainer').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        document.getElementById('loginSuccess').classList.add('hidden');
    }

    function showLoginForm() {
        document.getElementById('loginFormContainer').classList.remove('hidden');
        document.getElementById('resetFormContainer').classList.add('hidden');
        document.getElementById('resetError').classList.add('hidden');
        document.getElementById('resetSuccess').classList.add('hidden');
    }

    document.getElementById('resetForm').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('resetEmail').value;
        const errorEl = document.getElementById('resetError');
        const successEl = document.getElementById('resetSuccess');
        
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');

        try {
            const { error } = await sb.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + window.location.pathname
            });

            if (error) throw error;

            successEl.textContent = `Email de r√©initialisation envoy√© √† ${email}. V√©rifiez votre bo√Æte mail.`;
            successEl.classList.remove('hidden');
            
            document.getElementById('resetEmail').value = '';
        } catch (error) {
            errorEl.textContent = error.message || 'Erreur lors de l\'envoi de l\'email';
            errorEl.classList.remove('hidden');
        }
    };

    // NAVIGATION
    function showHome() {
        // Cacher tout
        document.getElementById('pageHome').classList.add('hidden');
        document.getElementById('navSteps').classList.add('hidden');
        for (let i = 0; i <= 5; i++) {
            document.getElementById('step' + i).classList.add('hidden');
        }
        document.getElementById('stepEvalManager').classList.add('hidden');

        // Afficher accueil
        document.getElementById('pageHome').classList.remove('hidden');
        
        if (userRole === 'admin_rh') {
            document.getElementById('adminActions').classList.remove('hidden');
            document.getElementById('managerView').classList.add('hidden');
        } else {
            document.getElementById('adminActions').classList.add('hidden');
            document.getElementById('managerView').classList.remove('hidden');
            chargerEquipeManager();
        }

        chargerKPIsAccueil();
    }

    function showStep(num) {
        document.getElementById('pageHome').classList.add('hidden');
        document.getElementById('navSteps').classList.remove('hidden');
        document.getElementById('stepEvalManager').classList.add('hidden');

        for (let i = 0; i <= 5; i++) {
            document.getElementById('step' + i).classList.add('hidden');
            document.getElementById('tab' + i)?.classList.remove('border-teal-500');
        }
        document.getElementById('step' + num).classList.remove('hidden');
        document.getElementById('tab' + num).classList.add('border-teal-500');

        if (num === 0) chargerManagers();
        if (num === 1) chargerPostes();
        if (num === 2) { chargerPostes(); chargerCompetencesPostes(); }
        if (num === 3) { chargerPostes(); chargerManagers(); chargerSalaries(); }
        if (num === 4) chargerSalaries();
        if (num === 5) chargerResultats();
    }

    function showEvalManager() {
        document.getElementById('pageHome').classList.add('hidden');
        document.getElementById('navSteps').classList.add('hidden');
        for (let i = 0; i <= 5; i++) {
            document.getElementById('step' + i).classList.add('hidden');
        }
        document.getElementById('stepEvalManager').classList.remove('hidden');
        chargerSalariesManager();
        chargerEcartsManager(); // Charger les √©carts au chargement
    }

    // ACCUEIL
    async function chargerKPIsAccueil() {
        const { data: collabs } = await sb.from('collaborateurs').select('*').eq('entreprise_id', entrepriseId);
        const { data: postes } = await sb.from('metiers').select('*').eq('entreprise_id', entrepriseId);
        const { data: comps } = await sb.from('competences').select('*').eq('entreprise_id', entrepriseId);
        const { data: evals } = await sb.from('evaluations_competences').select('*');

        document.getElementById('homeCollabs').textContent = (collabs || []).length;
        document.getElementById('homePostes').textContent = (postes || []).length;
        document.getElementById('homeComps').textContent = (comps || []).length;
        
        const ecarts = (evals || []).filter(e => e.niveau_actuel < e.niveau_requis).length;
        document.getElementById('homeEcarts').textContent = ecarts;
    }

    async function chargerEquipeManager() {
        // Charger tous les collaborateurs du manager (N) + leurs sous-collaborateurs (si manager)
        const { data: directs } = await sb.from('collaborateurs').select(`
            *, metier:metiers(nom)
        `).eq('manager_id', currentUserId);

        const el = document.getElementById('managerTeam');
        if (!directs || directs.length === 0) {
            el.innerHTML = '<p class="text-gray-500">Aucun collaborateur assign√©</p>';
        } else {
            el.innerHTML = '<div class="space-y-2">' + directs.map(c => `
                <div class="p-3 bg-gray-50 rounded">
                    <span class="font-medium">${c.nom} ${c.prenom}</span>
                    <span class="text-sm text-gray-600 ml-2">${c.metier?.nom || 'Sans poste'}</span>
                </div>
            `).join('') + '</div>';
        }
    }

    // √âTAPE 0 : MANAGERS
    async function creerManager() {
        const email = document.getElementById('mgrEmail').value.trim();
        const nom = document.getElementById('mgrNom').value.trim();
        const password = document.getElementById('mgrPassword').value.trim();

        if (!email || !nom || !password) {
            alert('Tous les champs sont requis');
            return;
        }

        if (password.length < 6) {
            alert('Le mot de passe doit contenir au moins 6 caract√®res');
            return;
        }

        // G√©n√©rer le code SQL
        const sqlCode = `-- Cr√©er le manager : ${nom}
DO $$
DECLARE
    v_user_id UUID;
BEGIN
    -- Cr√©er le compte auth
    INSERT INTO auth.users (
        instance_id, id, aud, role, email, encrypted_password,
        email_confirmed_at, created_at, updated_at,
        raw_app_meta_data, raw_user_meta_data,
        confirmation_token, email_change, email_change_token_new, recovery_token
    ) VALUES (
        '00000000-0000-0000-0000-000000000000',
        gen_random_uuid(),
        'authenticated',
        'authenticated',
        '${email}',
        crypt('${password}', gen_salt('bf')),
        NOW(), NOW(), NOW(),
        '{"provider":"email","providers":["email"]}',
        '{}',
        '', '', '', ''
    )
    RETURNING id INTO v_user_id;

    -- Cr√©er le profil
    INSERT INTO profils (id, entreprise_id, email, nom_complet, role, actif)
    VALUES (v_user_id, '${entrepriseId}', '${email}', '${nom}', 'manager', true);

    RAISE NOTICE 'Manager cr√©√© : ${email}';
END $$;`;

        const status = document.getElementById('mgrStatus');
        status.className = 'mt-4 p-3 rounded-lg text-sm bg-blue-50 text-blue-800 border border-blue-200';
        status.innerHTML = `
            <div class="mb-3">
                <strong>üìã Code SQL g√©n√©r√©</strong>
                <p class="text-xs mt-1">Copiez ce code et collez-le dans Supabase ‚Üí SQL Editor</p>
            </div>
            <div class="bg-white p-3 rounded border border-blue-300 mb-3 max-h-48 overflow-y-auto">
                <pre class="text-xs" style="white-space: pre-wrap;">${sqlCode}</pre>
            </div>
            <div class="flex gap-2">
                <button onclick="copierSQL(this)" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">
                    üìã Copier le code SQL
                </button>
                <button onclick="ouvrirSupabase()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    üîó Ouvrir Supabase SQL Editor
                </button>
            </div>
            <div class="mt-3 text-xs">
                <strong>Identifiants du manager :</strong><br>
                Email : ${email}<br>
                Mot de passe : ${password}
            </div>
        `;
        status.classList.remove('hidden');

        // Sauvegarder le code SQL dans un attribut pour le copier
        status.dataset.sqlCode = sqlCode;
    }

    function copierSQL(button) {
        const status = document.getElementById('mgrStatus');
        const sqlCode = status.dataset.sqlCode;
        
        navigator.clipboard.writeText(sqlCode).then(() => {
            const originalText = button.textContent;
            button.textContent = '‚úÖ Copi√© !';
            button.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            button.classList.add('bg-green-600');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-600');
                button.classList.add('bg-teal-600', 'hover:bg-teal-700');
            }, 2000);
        }).catch(() => {
            alert('Erreur de copie. S√©lectionnez et copiez manuellement le code ci-dessus.');
        });
    }

    function ouvrirSupabase() {
        window.open('https://supabase.com/dashboard/project/dqmzvxourispelgvjwze/sql/new', '_blank');
    }

    async function chargerManagers() {
        const { data } = await sb.from('profils').select('*')
            .eq('entreprise_id', entrepriseId)
            .eq('role', 'manager');

        const el = document.getElementById('listeManagers');
        if (!data || data.length === 0) {
            el.innerHTML = '<p class="text-gray-500">Aucun manager</p>';
        } else {
            el.innerHTML = '<div class="space-y-2">' + data.map(m => `
                <div class="p-3 bg-gray-50 rounded flex justify-between items-center">
                    <div class="flex-1">
                        <span class="font-medium block">${m.nom_complet}</span>
                        <span class="text-sm text-gray-600">${m.email}</span>
                    </div>
                    <button onclick="supprimerManager('${m.id}', '${m.nom_complet}')" 
                        class="ml-4 px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            `).join('') + '</div>';
        }

        // Select salari√©
        const select = document.getElementById('salManager');
        select.innerHTML = '<option value="">S√©lectionner un manager</option>' +
            (data || []).map(m => `<option value="${m.id}">${m.nom_complet}</option>`).join('');
    }

    async function supprimerManager(id, nom) {
        if (!confirm(`Supprimer le manager "${nom}" ?\n\n‚ö†Ô∏è Les salari√©s rattach√©s √† ce manager seront sans manager.`)) {
            return;
        }

        try {
            // D√©tacher les salari√©s de ce manager
            await sb.from('collaborateurs')
                .update({ manager_id: null })
                .eq('manager_id', id);

            // Supprimer le profil
            await sb.from('profils')
                .delete()
                .eq('id', id);

            // Supprimer le compte auth
            // Note: n√©cessite des permissions sp√©ciales, peut √©chouer
            // Le compte auth restera mais sans profil
            
            alert('‚úÖ Manager supprim√©');
            chargerManagers();
            chargerSalaries();
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    // √âTAPE 1-2-3 identiques √† avant (code d√©j√† √©crit)
    async function ajouterPoste() {
        const nom = document.getElementById('posteNom').value.trim();
        if (!nom) { alert('Nom obligatoire'); return; }
        await sb.from('metiers').insert({
            entreprise_id: entrepriseId,
            nom: nom,
            description: document.getElementById('posteDesc').value.trim()
        });
        document.getElementById('posteNom').value = '';
        document.getElementById('posteDesc').value = '';
        chargerPostes();
    }

    async function chargerPostes() {
        const { data } = await sb.from('metiers').select('*').eq('entreprise_id', entrepriseId);
        const el = document.getElementById('listePostes');
        el.innerHTML = !data || data.length === 0 ? '<p class="text-gray-500">Aucun poste</p>' :
            '<div class="space-y-2">' + data.map(p => `
                <div class="p-3 bg-gray-50 rounded flex justify-between items-center">
                    <span class="font-medium">${p.nom}</span>
                    <button onclick="supprimerPoste('${p.id}', '${p.nom}')" 
                        class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            `).join('') + '</div>';
        
        const opts = '<option value="">S√©lectionner un poste</option>' +
            (data || []).map(p => `<option value="${p.id}">${p.nom}</option>`).join('');
        document.getElementById('compPosteSelect').innerHTML = opts;
        document.getElementById('salPoste').innerHTML = opts;
    }

    async function supprimerPoste(id, nom) {
        if (!confirm(`Supprimer le poste "${nom}" ?\n\n‚ö†Ô∏è Cela supprimera aussi :\n- Les comp√©tences associ√©es\n- Les √©valuations des salari√©s de ce poste`)) {
            return;
        }

        try {
            // Supprimer les √©valuations
            const { data: salaries } = await sb.from('collaborateurs')
                .select('id')
                .eq('metier_id', id);
            
            if (salaries && salaries.length > 0) {
                const salarieIds = salaries.map(s => s.id);
                await sb.from('evaluations_competences')
                    .delete()
                    .in('collaborateur_id', salarieIds);
            }

            // Supprimer les niveaux attendus
            await sb.from('niveaux_attendus')
                .delete()
                .eq('metier_id', id);

            // Mettre les salari√©s sans poste
            await sb.from('collaborateurs')
                .update({ metier_id: null })
                .eq('metier_id', id);

            // Supprimer le poste
            const { error } = await sb.from('metiers')
                .delete()
                .eq('id', id);

            if (error) throw error;

            alert('‚úÖ Poste supprim√©');
            chargerPostes();
            chargerCompetencesPostes();
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    async function ajouterCompetencePoste() {
        const posteId = document.getElementById('compPosteSelect').value;
        const nom = document.getElementById('compNom').value.trim();
        const niveau = parseInt(document.getElementById('compNiveauReqis').value);
        
        if (!posteId || !nom || isNaN(niveau)) { 
            alert('Tous les champs requis'); 
            return; 
        }

        try {
            // V√©rifier si la comp√©tence existe d√©j√†
            let { data: existingComp } = await sb.from('competences')
                .select('id')
                .eq('entreprise_id', entrepriseId)
                .eq('nom', nom)
                .single();

            let competenceId;

            if (existingComp) {
                // La comp√©tence existe d√©j√†, on la r√©utilise
                competenceId = existingComp.id;
            } else {
                // Cr√©er une nouvelle comp√©tence
                const { data: newComp, error: compError } = await sb.from('competences').insert({
                    entreprise_id: entrepriseId,
                    nom: nom,
                    categorie: document.getElementById('compCategorie').value
                }).select().single();

                if (compError) {
                    alert('Erreur lors de la cr√©ation de la comp√©tence : ' + compError.message);
                    return;
                }

                competenceId = newComp.id;
            }

            // V√©rifier si cette comp√©tence n'est pas d√©j√† assign√©e √† ce poste
            const { data: existingNiveau } = await sb.from('niveaux_attendus')
                .select('id')
                .eq('metier_id', posteId)
                .eq('competence_id', competenceId)
                .single();

            if (existingNiveau) {
                alert('Cette comp√©tence est d√©j√† assign√©e √† ce poste');
                return;
            }

            // Ajouter le niveau attendu
            const { error: niveauError } = await sb.from('niveaux_attendus').insert({
                metier_id: posteId,
                competence_id: competenceId,
                niveau_requis: niveau
            });

            if (niveauError) {
                alert('Erreur : ' + niveauError.message);
                return;
            }

            // Succ√®s !
            document.getElementById('compNom').value = '';
            document.getElementById('compNiveauReqis').value = '';
            chargerCompetencesPostes();

        } catch (error) {
            console.error('Erreur:', error);
            alert('Une erreur est survenue : ' + error.message);
        }
    }

    async function chargerCompetencesPostes() {
        const { data } = await sb.from('niveaux_attendus').select(`
            *, 
            metier:metiers!inner(nom, entreprise_id), 
            competence:competences(nom, categorie)
        `).eq('metier.entreprise_id', entrepriseId);
        
        const el = document.getElementById('listeCompetencesPostes');
        if (!data || data.length === 0) {
            el.innerHTML = '<p class="text-gray-500">Aucune comp√©tence</p>';
        } else {
            const byPoste = {};
            data.forEach(n => {
                const p = n.metier.nom;
                if (!byPoste[p]) byPoste[p] = [];
                byPoste[p].push(n);
            });
            el.innerHTML = Object.entries(byPoste).map(([p, comps]) => `
                <div class="border rounded-lg p-4">
                    <h4 class="font-bold mb-3">${p}</h4>
                    <div class="space-y-2">
                        ${comps.map(c => `
                            <div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                <span>${c.competence.nom} (${c.competence.categorie}) ‚Üí ${c.niveau_requis}/5</span>
                                <button onclick="supprimerCompetence('${c.id}', '${c.competence.nom}')" 
                                    class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
    }

    async function supprimerCompetence(niveauId, nom) {
        if (!confirm(`Supprimer la comp√©tence "${nom}" de ce poste ?\n\n‚ö†Ô∏è Cela supprimera aussi les √©valuations associ√©es.`)) {
            return;
        }

        try {
            // R√©cup√©rer l'info avant suppression
            const { data: niveau } = await sb.from('niveaux_attendus')
                .select('competence_id, metier_id')
                .eq('id', niveauId)
                .single();

            if (niveau) {
                // Supprimer les √©valuations
                const { data: salaries } = await sb.from('collaborateurs')
                    .select('id')
                    .eq('metier_id', niveau.metier_id);

                if (salaries && salaries.length > 0) {
                    const salarieIds = salaries.map(s => s.id);
                    await sb.from('evaluations_competences')
                        .delete()
                        .eq('competence_id', niveau.competence_id)
                        .in('collaborateur_id', salarieIds);
                }
            }

            // Supprimer le niveau attendu
            const { error } = await sb.from('niveaux_attendus')
                .delete()
                .eq('id', niveauId);

            if (error) throw error;

            alert('‚úÖ Comp√©tence supprim√©e');
            chargerCompetencesPostes();
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    async function ajouterSalarie() {
        const nom = document.getElementById('salNom').value.trim();
        const email = document.getElementById('salEmail').value.trim();
        const posteId = document.getElementById('salPoste').value;
        const managerId = document.getElementById('salManager').value;

        if (!nom || !email || !posteId) {
            alert('Nom, email et poste requis');
            return;
        }

        try {
            // V√©rifier si l'email existe d√©j√†
            const { data: existing } = await sb.from('collaborateurs')
                .select('id')
                .eq('entreprise_id', entrepriseId)
                .eq('email', email)
                .single();

            if (existing) {
                alert('Un salari√© avec cet email existe d√©j√†');
                return;
            }

            // Cr√©er le salari√©
            const { error } = await sb.from('collaborateurs').insert({
                entreprise_id: entrepriseId,
                nom: nom,
                prenom: document.getElementById('salPrenom').value.trim(),
                email: email,
                metier_id: posteId,
                manager_id: managerId || null,
                actif: true
            });

            if (error) {
                console.error('Erreur cr√©ation salari√©:', error);
                alert('Erreur : ' + error.message);
                return;
            }

            // Succ√®s !
            document.getElementById('salNom').value = '';
            document.getElementById('salPrenom').value = '';
            document.getElementById('salEmail').value = '';
            chargerSalaries();

        } catch (error) {
            console.error('Erreur:', error);
            alert('Une erreur est survenue : ' + error.message);
        }
    }

    async function chargerSalaries() {
        const { data } = await sb.from('collaborateurs').select(`
            *, 
            metier:metiers(nom), 
            manager:profils!manager_id(nom_complet)
        `).eq('entreprise_id', entrepriseId);

        const el = document.getElementById('listeSalaries');
        el.innerHTML = !data || data.length === 0 ? '<p class="text-gray-500">Aucun salari√©</p>' :
            '<div class="space-y-2">' + data.map(s => `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center hover:bg-gray-100">
                    <div class="flex-1">
                        <div class="font-bold text-lg">${s.nom} ${s.prenom}</div>
                        <div class="text-sm text-gray-600 mt-1">
                            üìß ${s.email}<br>
                            üíº ${s.metier?.nom || 'Sans poste'}<br>
                            üë§ Manager: ${s.manager?.nom_complet || 'Aucun'}
                        </div>
                    </div>
                    <button onclick="supprimerSalarie('${s.id}', '${s.nom} ${s.prenom}')" 
                        class="ml-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            `).join('') + '</div>';

        const opts = '<option value="">S√©lectionner un salari√©</option>' +
            (data || []).map(s => `<option value="${s.id}" data-metier="${s.metier_id}">${s.nom} ${s.prenom}</option>`).join('');
        document.getElementById('evalSalarie').innerHTML = opts;
    }

    async function chargerSalariesManager() {
        const { data } = await sb.from('collaborateurs').select('*, metier:metiers(nom)')
            .eq('manager_id', currentUserId);

        const select = document.getElementById('evalManagerSalarie');
        select.innerHTML = '<option value="">S√©lectionner un collaborateur</option>' +
            (data || []).map(s => `<option value="${s.id}" data-metier="${s.metier_id}">${s.nom} ${s.prenom}</option>`).join('');
    }

    // √âVALUER (ADMIN)
    async function chargerCompetencesSalarie() {
        const select = document.getElementById('evalSalarie');
        const salId = select.value;
        const metId = select.selectedOptions[0]?.dataset.metier;
        if (!salId || !metId) return;

        // R√©cup√©rer les comp√©tences requises
        const { data: niveaux } = await sb.from('niveaux_attendus').select('*, competence:competences(*)')
            .eq('metier_id', metId);

        // R√©cup√©rer les √©valuations pr√©c√©dentes
        const { data: evalsPrec } = await sb.from('evaluations_competences')
            .select('competence_id, niveau_actuel, date_evaluation')
            .eq('collaborateur_id', salId)
            .order('date_evaluation', { ascending: false });

        // Cr√©er un map des derni√®res √©valuations par comp√©tence
        const dernieresEvals = {};
        (evalsPrec || []).forEach(e => {
            if (!dernieresEvals[e.competence_id]) {
                dernieresEvals[e.competence_id] = e;
            }
        });

        const el = document.getElementById('evalCompetences');
        if (!niveaux || niveaux.length === 0) {
            el.innerHTML = '<p class="text-gray-500">Aucune comp√©tence pour ce poste</p>';
            document.getElementById('btnSaveEval').classList.add('hidden');
        } else {
            el.innerHTML = '<div class="space-y-3">' + niveaux.map(n => {
                const derniere = dernieresEvals[n.competence.id];
                const niveauPrec = derniere ? derniere.niveau_actuel : 0;
                const datePrec = derniere ? new Date(derniere.date_evaluation).toLocaleDateString('fr-FR') : 'Jamais √©valu√©';
                
                return `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-bold text-lg">${n.competence.nom}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                        Requis: ${n.niveau_requis}/5
                                    </span>
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs ml-2">
                                        Pr√©c√©dent: ${niveauPrec}/5 (${datePrec})
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium">Nouveau niveau :</label>
                                <input type="number" min="0" max="5" 
                                    value="${niveauPrec}"
                                    data-comp="${n.competence.id}" 
                                    data-requis="${n.niveau_requis}"
                                    class="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg text-center font-bold text-lg focus:border-teal-500 focus:outline-none">
                            </div>
                        </div>
                    </div>
                `;
            }).join('') + '</div>';
            document.getElementById('btnSaveEval').classList.remove('hidden');
        }
    }

    async function enregistrerEvaluations() {
        const salId = document.getElementById('evalSalarie').value;
        const inputs = document.querySelectorAll('#evalCompetences input[data-comp]');
        const evals = [];
        
        inputs.forEach(input => {
            const val = parseInt(input.value);
            if (!isNaN(val)) {
                evals.push({
                    collaborateur_id: salId,
                    competence_id: input.dataset.comp,
                    niveau_actuel: val,
                    date_evaluation: new Date().toISOString().split('T')[0] // Format DATE: YYYY-MM-DD
                });
            }
        });

        if (evals.length === 0) { 
            alert('√âvaluez au moins 1 comp√©tence'); 
            return; 
        }

        try {
            const { error } = await sb.from('evaluations_competences').insert(evals);
            
            if (error) {
                console.error('Erreur insertion:', error);
                alert('‚ùå Erreur : ' + error.message);
                return;
            }

            alert(`‚úÖ ${evals.length} √©valuations enregistr√©es`);
            document.getElementById('evalSalarie').value = '';
            document.getElementById('evalCompetences').innerHTML = '';
            document.getElementById('btnSaveEval').classList.add('hidden');
            chargerResultats(); // Rafra√Æchir les r√©sultats
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    // √âVALUER (MANAGER)
    async function chargerCompetencesSalarieManager() {
        const select = document.getElementById('evalManagerSalarie');
        const salId = select.value;
        const metId = select.selectedOptions[0]?.dataset.metier;
        if (!salId || !metId) return;

        // R√©cup√©rer les comp√©tences requises
        const { data: niveaux } = await sb.from('niveaux_attendus').select('*, competence:competences(*)')
            .eq('metier_id', metId);

        // R√©cup√©rer les √©valuations pr√©c√©dentes
        const { data: evalsPrec } = await sb.from('evaluations_competences')
            .select('*')
            .eq('collaborateur_id', salId)
            .order('date_evaluation', { ascending: false });

        // Cr√©er un map des derni√®res √©valuations par comp√©tence
        const dernieresEvals = {};
        (evalsPrec || []).forEach(e => {
            if (!dernieresEvals[e.competence_id]) {
                dernieresEvals[e.competence_id] = e;
            }
        });

        const el = document.getElementById('evalManagerCompetences');
        if (!niveaux || niveaux.length === 0) {
            el.innerHTML = '<p class="text-gray-500">Aucune comp√©tence</p>';
            document.getElementById('btnSaveEvalManager').classList.add('hidden');
        } else {
            el.innerHTML = '<div class="space-y-3">' + niveaux.map(n => {
                const derniere = dernieresEvals[n.competence.id];
                const niveauPrec = derniere ? derniere.niveau_actuel : 0;
                const datePrec = derniere ? new Date(derniere.date_evaluation).toLocaleDateString('fr-FR') : 'Jamais √©valu√©';
                
                return `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-bold text-lg">${n.competence.nom}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                        Requis: ${n.niveau_requis}/5
                                    </span>
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs ml-2">
                                        Pr√©c√©dent: ${niveauPrec}/5 (${datePrec})
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium">Nouveau niveau :</label>
                                <input type="number" min="0" max="5" 
                                    value="${niveauPrec}"
                                    data-comp="${n.competence.id}" 
                                    data-requis="${n.niveau_requis}"
                                    data-evalid="${derniere?.id || ''}"
                                    class="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg text-center font-bold text-lg focus:border-teal-500 focus:outline-none">
                            </div>
                        </div>
                    </div>
                `;
            }).join('') + '</div>';
            document.getElementById('btnSaveEvalManager').classList.remove('hidden');
        }
    }

    async function enregistrerEvaluationsManager() {
        const salId = document.getElementById('evalManagerSalarie').value;
        const inputs = document.querySelectorAll('#evalManagerCompetences input[data-comp]');
        
        try {
            let nbSaved = 0;
            
            for (const input of inputs) {
                const val = parseInt(input.value);
                if (!isNaN(val)) {
                    const evalId = input.dataset.evalid;
                    const data = {
                        collaborateur_id: salId,
                        competence_id: input.dataset.comp,
                        niveau_actuel: val,
                        date_evaluation: new Date().toISOString().split('T')[0] // Format DATE
                    };

                    if (evalId) {
                        // Update
                        const { error } = await sb.from('evaluations_competences')
                            .update({ 
                                niveau_actuel: val,
                                date_evaluation: new Date().toISOString().split('T')[0]
                            })
                            .eq('id', evalId);
                        
                        if (error) throw error;
                    } else {
                        // Insert
                        const { error } = await sb.from('evaluations_competences').insert(data);
                        if (error) throw error;
                    }
                    nbSaved++;
                }
            }

            if (nbSaved === 0) {
                alert('√âvaluez au moins 1 comp√©tence');
                return;
            }

            alert(`‚úÖ ${nbSaved} √©valuations enregistr√©es`);
            document.getElementById('evalManagerSalarie').value = '';
            document.getElementById('evalManagerCompetences').innerHTML = '';
            document.getElementById('btnSaveEvalManager').classList.add('hidden');
            chargerEcartsManager(); // Rafra√Æchir les √©carts
            
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    // √âCARTS MANAGER
    async function chargerEcartsManager() {
        try {
            // R√©cup√©rer les collaborateurs du manager
            const { data: mesCollabs } = await sb.from('collaborateurs')
                .select('id, nom, prenom, metier_id, metier:metiers(nom)')
                .eq('manager_id', currentUserId);

            if (!mesCollabs || mesCollabs.length === 0) {
                document.getElementById('tableEcartsManager').innerHTML = 
                    '<p class="text-gray-500 text-center py-8">Aucun collaborateur assign√©</p>';
                return;
            }

            const collabIds = mesCollabs.map(c => c.id);

            // R√©cup√©rer les niveaux requis
            const { data: niveauxAttendus } = await sb.from('niveaux_attendus')
                .select('metier_id, competence_id, niveau_requis');
            
            const niveauxMap = {};
            (niveauxAttendus || []).forEach(n => {
                const key = `${n.metier_id}_${n.competence_id}`;
                niveauxMap[key] = n.niveau_requis;
            });

            // R√©cup√©rer les √©valuations
            const { data: evals } = await sb.from('evaluations_competences')
                .select(`
                    *, 
                    collaborateur:collaborateurs!inner(nom, prenom, metier_id, metier:metiers(nom)),
                    competence:competences(nom, categorie)
                `)
                .in('collaborateur_id', collabIds);

            // Ajouter niveau_requis
            const evalsAvecRequis = (evals || []).map(e => {
                const key = `${e.collaborateur.metier_id}_${e.competence_id}`;
                const niveauRequis = niveauxMap[key] || 0;
                return { ...e, niveau_requis: niveauRequis };
            });

            const ecarts = evalsAvecRequis.filter(e => e.niveau_actuel < e.niveau_requis);

            // Mettre √† jour les KPIs
            document.getElementById('managerCollabs').textContent = mesCollabs.length;
            document.getElementById('managerEcarts').textContent = ecarts.length;
            
            const compsUniques = [...new Set(ecarts.map(e => e.competence.nom))];
            document.getElementById('managerComps').textContent = compsUniques.length;

            const el = document.getElementById('tableEcartsManager');

            if (ecarts.length === 0) {
                el.innerHTML = '<p class="text-green-600 text-center py-8">‚úÖ Aucun √©cart de comp√©tence dans votre √©quipe</p>';
                return;
            }

            // Grouper par comp√©tence
            const parCompetence = {};
            ecarts.forEach(e => {
                const comp = e.competence.nom;
                if (!parCompetence[comp]) parCompetence[comp] = { 
                    count: 0, 
                    ecartTotal: 0, 
                    salaries: [],
                    categorie: e.competence.categorie 
                };
                parCompetence[comp].count++;
                parCompetence[comp].ecartTotal += (e.niveau_requis - e.niveau_actuel);
                parCompetence[comp].salaries.push(`${e.collaborateur.nom} ${e.collaborateur.prenom}`);
            });

            const topCompetences = Object.entries(parCompetence)
                .sort((a, b) => b[1].count - a[1].count);

            el.innerHTML = `
                <!-- Top comp√©tences √† former -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-orange-800">üéØ Priorit√©s de Formation</h3>
                    <div class="space-y-3">
                        ${topCompetences.map(([comp, info]) => `
                            <div class="bg-white p-4 rounded-lg border border-orange-100">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <div class="font-semibold text-lg">${comp}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs">
                                                ${info.categorie}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-orange-600">${info.count}</div>
                                        <div class="text-xs text-gray-600">personne(s)</div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-700 mt-2">
                                    <strong>Concern√©s :</strong> ${info.salaries.join(', ')}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    √âcart total : ${info.ecartTotal} niveaux
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Tableau d√©taill√© -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h3 class="font-bold">üìã D√©tail des √âcarts par Collaborateur</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold">Collaborateur</th>
                                    <th class="px-4 py-3 text-left font-semibold">Comp√©tence</th>
                                    <th class="px-4 py-3 text-center font-semibold">Niveau Actuel</th>
                                    <th class="px-4 py-3 text-center font-semibold">Niveau Requis</th>
                                    <th class="px-4 py-3 text-center font-semibold">√âcart</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ecarts.map(e => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-4 py-3 font-medium">${e.collaborateur.nom} ${e.collaborateur.prenom}</td>
                                        <td class="px-4 py-3">${e.competence.nom}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded font-semibold">${e.niveau_actuel}/5</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded font-semibold">${e.niveau_requis}/5</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-red-100 text-red-800 rounded font-bold">-${e.niveau_requis - e.niveau_actuel}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

        } catch (error) {
            console.error('Erreur chargement √©carts:', error);
            document.getElementById('tableEcartsManager').innerHTML = 
                '<p class="text-red-600 text-center py-8">‚ùå Erreur de chargement</p>';
        }
    }

    // R√âSULTATS
    async function chargerResultats() {
        const { data: collabs } = await sb.from('collaborateurs').select('*').eq('entreprise_id', entrepriseId);
        const { data: postes } = await sb.from('metiers').select('*').eq('entreprise_id', entrepriseId);
        const { data: comps } = await sb.from('competences').select('*').eq('entreprise_id', entrepriseId);
        
        // R√©cup√©rer les niveaux requis par m√©tier et comp√©tence
        const { data: niveauxAttendus } = await sb.from('niveaux_attendus').select('metier_id, competence_id, niveau_requis');
        
        // Cr√©er un map pour acc√®s rapide
        const niveauxMap = {};
        (niveauxAttendus || []).forEach(n => {
            const key = `${n.metier_id}_${n.competence_id}`;
            niveauxMap[key] = n.niveau_requis;
        });
        
        // R√©cup√©rer TOUTES les √©valuations avec filtre sur entreprise via collaborateurs
        const { data: evals } = await sb.from('evaluations_competences').select(`
            *, 
            collaborateur:collaborateurs!inner(nom, prenom, entreprise_id, metier_id, metier:metiers(nom)),
            competence:competences(nom, categorie)
        `).eq('collaborateur.entreprise_id', entrepriseId);

        console.log('√âvaluations r√©cup√©r√©es:', evals?.length || 0);

        // Ajouter le niveau_requis √† chaque √©valuation
        const evalsAvecRequis = (evals || []).map(e => {
            const key = `${e.collaborateur.metier_id}_${e.competence_id}`;
            const niveauRequis = niveauxMap[key] || 0;
            return { ...e, niveau_requis: niveauRequis };
        });

        document.getElementById('resCollabs').textContent = (collabs || []).length;
        document.getElementById('resPostes').textContent = (postes || []).length;
        document.getElementById('resComps').textContent = (comps || []).length;

        const ecarts = evalsAvecRequis.filter(e => e.niveau_actuel < e.niveau_requis);
        document.getElementById('resEcarts').textContent = ecarts.length;

        const el = document.getElementById('tableEcarts');
        
        if (ecarts.length === 0) {
            el.innerHTML = '<p class="text-green-600 text-center py-8">‚úÖ Aucun √©cart de comp√©tence d√©tect√©</p>';
        } else {
            // Grouper par poste
            const parPoste = {};
            ecarts.forEach(e => {
                const poste = e.collaborateur.metier?.nom || 'Sans poste';
                if (!parPoste[poste]) parPoste[poste] = [];
                parPoste[poste].push(e);
            });

            // Grouper par comp√©tence
            const parCompetence = {};
            ecarts.forEach(e => {
                const comp = e.competence.nom;
                if (!parCompetence[comp]) parCompetence[comp] = { count: 0, ecartTotal: 0, salaries: [] };
                parCompetence[comp].count++;
                parCompetence[comp].ecartTotal += (e.niveau_requis - e.niveau_actuel);
                parCompetence[comp].salaries.push(`${e.collaborateur.nom} ${e.collaborateur.prenom}`);
            });

            // Trier comp√©tences par nombre d'√©carts
            const topCompetences = Object.entries(parCompetence)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            el.innerHTML = `
                <!-- Synth√®se -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Top comp√©tences √† former -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-orange-800">üéØ Top Comp√©tences √† Former</h3>
                        <div class="space-y-2">
                            ${topCompetences.map(([comp, info]) => `
                                <div class="bg-white p-3 rounded border border-orange-100">
                                    <div class="font-semibold">${comp}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        ${info.count} personne(s) concern√©e(s) - √âcart total: ${info.ecartTotal} niveaux
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${info.salaries.slice(0, 3).join(', ')}${info.salaries.length > 3 ? '...' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- √âcarts par poste -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-blue-800">üíº √âcarts par Poste</h3>
                        <div class="space-y-2">
                            ${Object.entries(parPoste).map(([poste, ecartsPoste]) => `
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <div class="font-semibold">${poste}</div>
                                    <div class="text-sm text-gray-600">
                                        ${ecartsPoste.length} √©cart(s) - 
                                        ${[...new Set(ecartsPoste.map(e => e.collaborateur.nom))].length} salari√©(s)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Tableau d√©taill√© -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h3 class="font-bold">üìã D√©tail des √âcarts</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold">Salari√©</th>
                                    <th class="px-4 py-3 text-left font-semibold">Poste</th>
                                    <th class="px-4 py-3 text-left font-semibold">Comp√©tence</th>
                                    <th class="px-4 py-3 text-center font-semibold">Niveau Actuel</th>
                                    <th class="px-4 py-3 text-center font-semibold">Niveau Requis</th>
                                    <th class="px-4 py-3 text-center font-semibold">√âcart</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ecarts.map(e => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-4 py-3">${e.collaborateur.nom} ${e.collaborateur.prenom}</td>
                                        <td class="px-4 py-3 text-gray-600">${e.collaborateur.metier?.nom || '-'}</td>
                                        <td class="px-4 py-3">${e.competence.nom}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded">${e.niveau_actuel}/5</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded">${e.niveau_requis}/5</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 bg-red-100 text-red-800 rounded font-bold">-${e.niveau_requis - e.niveau_actuel}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    }

    // SUPPRIMER SALARI√â
    async function supprimerSalarie(id, nom) {
        if (!confirm(`‚ö†Ô∏è Supprimer ${nom} ?\n\nCela supprimera aussi toutes ses √©valuations.`)) return;

        try {
            // Supprimer les √©valuations
            await sb.from('evaluations_competences').delete().eq('collaborateur_id', id);
            // Supprimer le salari√©
            await sb.from('collaborateurs').delete().eq('id', id);
            
            alert(`‚úÖ ${nom} supprim√©`);
            chargerSalaries();
            chargerKPIsAccueil();
        } catch (error) {
            alert('‚ùå Erreur : ' + error.message);
        }
    }

    // EXPORT BASE
    async function exporterBase() {
        if (!confirm('üì§ Exporter toute la base de donn√©es ?')) return;

        try {
            const { data: postes } = await sb.from('metiers').select('*').eq('entreprise_id', entrepriseId);
            const { data: comps } = await sb.from('competences').select('*').eq('entreprise_id', entrepriseId);
            const { data: niveaux } = await sb.from('niveaux_attendus').select('*');
            const { data: collabs } = await sb.from('collaborateurs').select('*').eq('entreprise_id', entrepriseId);
            const { data: evals } = await sb.from('evaluations_competences').select('*');

            const exportData = {
                version: '1.0',
                date: new Date().toISOString(),
                entreprise_id: entrepriseId,
                postes: postes || [],
                competences: comps || [],
                niveaux_attendus: niveaux || [],
                collaborateurs: collabs || [],
                evaluations: evals || []
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GEPP_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            alert('‚úÖ Export r√©ussi !');
        } catch (error) {
            alert('‚ùå Erreur export : ' + error.message);
        }
    }

    // IMPORT BASE
    function showImport() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm('‚ö†Ô∏è ATTENTION !\n\nL\'import va REMPLACER toutes les donn√©es actuelles.\n\nVoulez-vous continuer ?')) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // V√©rifier format
                if (!data.version || !data.postes) {
                    throw new Error('Format de fichier invalide');
                }

                // Supprimer donn√©es existantes
                await sb.from('evaluations_competences').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await sb.from('niveaux_attendus').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await sb.from('collaborateurs').delete().eq('entreprise_id', entrepriseId);
                await sb.from('competences').delete().eq('entreprise_id', entrepriseId);
                await sb.from('metiers').delete().eq('entreprise_id', entrepriseId);

                // Ins√©rer nouvelles donn√©es
                if (data.postes.length > 0) {
                    const postesWithEntreprise = data.postes.map(p => ({ ...p, entreprise_id: entrepriseId }));
                    await sb.from('metiers').insert(postesWithEntreprise);
                }

                if (data.competences.length > 0) {
                    const compsWithEntreprise = data.competences.map(c => ({ ...c, entreprise_id: entrepriseId }));
                    await sb.from('competences').insert(compsWithEntreprise);
                }

                if (data.niveaux_attendus.length > 0) {
                    await sb.from('niveaux_attendus').insert(data.niveaux_attendus);
                }

                if (data.collaborateurs.length > 0) {
                    const collabsWithEntreprise = data.collaborateurs.map(c => ({ ...c, entreprise_id: entrepriseId }));
                    await sb.from('collaborateurs').insert(collabsWithEntreprise);
                }

                if (data.evaluations.length > 0) {
                    await sb.from('evaluations_competences').insert(data.evaluations);
                }

                alert(`‚úÖ Import r√©ussi !\n\n${data.postes.length} postes\n${data.competences.length} comp√©tences\n${data.collaborateurs.length} collaborateurs\n${data.evaluations.length} √©valuations`);
                
                showHome();
            } catch (error) {
                alert('‚ùå Erreur import : ' + error.message);
            }
        };
        input.click();
    }
    </script>
</body>
</html>
